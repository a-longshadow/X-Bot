{% extends "base.html" %}

{% block title %}Campaigns - CoopHive{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
</div>

<!-- Upload Link -->
<div class="card" style="text-align: center; padding: 30px;">
    <h3 style="color: #667eea; margin-bottom: 15px;">üìÅ Need to Upload Data?</h3>
    <p style="color: #666; margin-bottom: 20px;">
        Upload JSON files containing tweet content for review and editing.
    </p>
    <a href="/upload" class="btn btn-primary" style="text-decoration: none;">
        Go to Upload Page
    </a>
</div>

<!-- Available Campaigns Section -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: #667eea; margin: 0;">üìã Available Campaigns</h3>
        <div id="bulkActionsContainer" style="display: none;">
            <label style="margin-right: 15px;">
                <input type="checkbox" id="selectAllCampaigns" onchange="toggleSelectAll()"> Select All
            </label>
            <button onclick="bulkDeleteCampaigns(false)" class="btn btn-warning" style="margin-right: 10px; font-size: 0.9rem;">
                üóëÔ∏è Soft Delete Selected
            </button>
            <button onclick="bulkDeleteCampaigns(true)" class="btn btn-danger" style="font-size: 0.9rem;">
                ‚ö†Ô∏è Permanently Delete Selected
            </button>
        </div>
    </div>
    <div id="campaignsList">
        <p style="color: #666; text-align: center;">Loading campaigns...</p>
    </div>
</div>

<script>
// Load and display available campaigns
async function loadCampaigns() {
    try {
        const response = await fetch('/api/campaigns');
        const result = await response.json();
        
        if (response.ok && result.campaigns) {
            const campaignsContainer = document.getElementById('campaignsList');
            
            if (result.campaigns.length === 0) {
                campaignsContainer.innerHTML = '<p style="color: #666; text-align: center;">No content available. <a href="/upload" style="color: #667eea;">Upload a JSON file</a> or receive data from n8n workflow.</p>';
                return;
            }
            
            // Sort campaigns by generated_at in reverse chronological order (newest first)
            result.campaigns.sort((a, b) => {
                const dateA = new Date(a.generated_at);
                const dateB = new Date(b.generated_at);
                return dateB - dateA; // Newest first
            });
            
            let campaignsHtml = '';
            result.campaigns.forEach(campaign => {
                // Create human-readable UTC date - "Tuesday 31-July-2025, 23:09:41"
                const dateObj = new Date(campaign.generated_at);
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'UTC'
                };
                const humanDate = dateObj.toLocaleDateString('en-US', options).replace(',', '') + ', ' + 
                                 dateObj.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'UTC', hour12: false});
                
                // Determine campaign type and color
                const isUpload = campaign.campaign_batch.startsWith('uploaded_');
                const isBatch = campaign.campaign_batch.startsWith('batch_');
                
                let campaignType = 'Unknown';
                let typeIcon = 'üìÑ';
                
                if (isUpload) {
                    campaignType = 'JSON Upload';
                    typeIcon = 'üìÅ';
                } else if (isBatch) {
                    campaignType = 'API Batch';
                    typeIcon = 'üîÑ';
                }
                
                // Determine status-based color coding
                const statusCounts = campaign.status_counts || {};
                const totalTweets = campaign.tweet_count;
                const approvedCount = statusCounts['Approved'] || 0;
                const postedCount = statusCounts['Posted'] || 0;
                const rejectedCount = statusCounts['Rejected'] || 0;
                const deletedCount = statusCounts['Deleted'] || 0;
                const draftCount = statusCounts['Draft'] || 0;
                
                // Calculate completion percentage (approved + posted)
                const completedCount = approvedCount + postedCount;
                const completionPercentage = totalTweets > 0 ? (completedCount / totalTweets) * 100 : 0;
                
                let borderColor = '#6c757d'; // Default grey
                let bgColor = '#f8f9fa'; // Default light grey
                let statusIcon = '‚è≥';
                let statusText = 'Pending';
                
                if (completionPercentage === 100) {
                    // All approved/posted - GREEN
                    borderColor = '#28a745';
                    bgColor = '#f8fff9';
                    statusIcon = '‚úÖ';
                    statusText = 'Complete';
                } else if (completionPercentage >= 50) {
                    // Partially approved/posted - YELLOW
                    borderColor = '#ffc107';
                    bgColor = '#fffdf0';
                    statusIcon = 'üîÑ';
                    statusText = 'In Progress';
                } else if (rejectedCount > 0 || deletedCount > 0) {
                    // Has rejected/deleted - ORANGE
                    borderColor = '#fd7e14';
                    bgColor = '#fff8f0';
                    statusIcon = '‚ö†Ô∏è';
                    statusText = 'Needs Review';
                } else {
                    // Mostly drafts - GREY
                    borderColor = '#6c757d';
                    bgColor = '#f8f9fa';
                    statusIcon = 'üìù';
                    statusText = 'Draft';
                }
                
                // Use display_name first, then title, then create readable name
                let displayName = campaign.display_name || campaign.title || campaign.campaign_batch;
                let subTitle = campaign.description || '';
                
                // If no display_name or title, create readable campaign name
                if (!campaign.display_name && !campaign.title) {
                    if (isUpload) {
                        const datePart = campaign.campaign_batch.replace('uploaded_', '');
                        const year = datePart.substring(0, 4);
                        const month = datePart.substring(4, 6);
                        const day = datePart.substring(6, 8);
                        const time = datePart.substring(9);
                        displayName = `Upload ${month}/${day}/${year} at ${time.substring(0,2)}:${time.substring(2,4)}`;
                    } else if (isBatch) {
                        displayName = campaign.campaign_batch.replace('batch_', 'Batch ').replace(/_/g, ' ');
                    }
                }
                
                campaignsHtml += `
                    <div style="background: ${bgColor}; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid ${borderColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="display: flex; align-items: flex-start; flex: 1;">
                                <label style="margin-right: 15px; margin-top: 5px;">
                                    <input type="checkbox" class="campaign-checkbox" value="${campaign.campaign_batch}" onchange="updateBulkActions()">
                                </label>
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <span style="font-size: 1.2rem; margin-right: 8px;">${typeIcon}</span>
                                        <span style="background: ${isUpload ? '#28a745' : '#007bff'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-right: 10px;">
                                            ${campaignType}
                                        </span>
                                        <span style="background: ${borderColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-right: 10px;">
                                            ${statusIcon} ${statusText}
                                        </span>
                                        <span style="color: #666; font-size: 0.8rem;">${campaign.campaign_batch}</span>
                                    </div>
                                    <h4 style="margin: 0 0 8px 0; color: #333; font-size: 1.1rem; cursor: pointer;" onclick="editCampaignName('${campaign.campaign_batch}', '${displayName.replace(/'/g, "\\'")}')">
                                        ${displayName} ‚úèÔ∏è
                                    </h4>
                                    ${subTitle ? `<div style="margin-bottom: 8px; color: #666; font-size: 0.9rem; font-style: italic;">${subTitle}</div>` : ''}
                                    <div style="margin-bottom: 8px; color: #666; font-size: 0.85rem;">
                                        <strong>Created:</strong> ${humanDate}
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 15px; color: #666; font-size: 0.9rem;">
                                        <span><strong>${campaign.tweet_count}</strong> tweets total</span>
                                        ${approvedCount > 0 ? `<span style="color: #28a745;">‚úÖ ${approvedCount} approved</span>` : ''}
                                        ${postedCount > 0 ? `<span style="color: #007bff;">üöÄ ${postedCount} posted</span>` : ''}
                                        ${draftCount > 0 ? `<span style="color: #6c757d;">üìù ${draftCount} drafts</span>` : ''}
                                        ${rejectedCount > 0 ? `<span style="color: #dc3545;">‚ùå ${rejectedCount} rejected</span>` : ''}
                                        ${deletedCount > 0 ? `<span style="color: #6c757d;">üóëÔ∏è ${deletedCount} deleted</span>` : ''}
                                        ${campaign.source ? `<span style="color: ${campaign.source === 'database' ? '#28a745' : '#ffc107'};">üìä ${campaign.source}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-left: 15px;">
                                <a href="/review/${campaign.campaign_batch}" class="btn btn-primary" style="text-decoration: none; background: ${borderColor}; border-color: ${borderColor}; font-size: 0.9rem;">
                                    üìù Review
                                </a>
                                <button onclick="deleteCampaign('${campaign.campaign_batch}', false)" class="btn btn-warning" style="font-size: 0.8rem;">
                                    üóëÔ∏è Soft Delete
                                </button>
                                <button onclick="deleteCampaign('${campaign.campaign_batch}', true)" class="btn btn-danger" style="font-size: 0.8rem;">
                                    ‚ö†Ô∏è Hard Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            campaignsContainer.innerHTML = campaignsHtml;
        }
    } catch (error) {
        console.error('Failed to load campaigns:', error);
    }
}

// Bulk actions functionality
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.campaign-checkbox');
    const checkedBoxes = document.querySelectorAll('.campaign-checkbox:checked');
    const bulkContainer = document.getElementById('bulkActionsContainer');
    
    if (checkedBoxes.length > 0) {
        bulkContainer.style.display = 'block';
    } else {
        bulkContainer.style.display = 'none';
    }
    
    // Update select all checkbox
    const selectAllCheckbox = document.getElementById('selectAllCampaigns');
    if (checkedBoxes.length === checkboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedBoxes.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCampaigns');
    const checkboxes = document.querySelectorAll('.campaign-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateBulkActions();
}

async function bulkDeleteCampaigns(hardDelete) {
    const checkedBoxes = document.querySelectorAll('.campaign-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('Please select campaigns to delete');
        return;
    }
    
    const campaignBatches = Array.from(checkedBoxes).map(cb => cb.value);
    const deleteType = hardDelete ? 'permanently delete' : 'soft delete';
    
    if (!confirm(`Are you sure you want to ${deleteType} ${campaignBatches.length} campaign(s)? This action ${hardDelete ? 'cannot be undone' : 'can be undone'}.`)) {
        return;
    }
    
    let successCount = 0;
    let errors = [];
    
    for (const campaignBatch of campaignBatches) {
        try {
            const response = await fetch('/api/delete-campaign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    campaign_batch: campaignBatch, 
                    hard_delete: hardDelete 
                })
            });
            
            const result = await response.json();
            if (result.status === 'success') {
                successCount++;
            } else {
                errors.push(`${campaignBatch}: ${result.message}`);
            }
        } catch (error) {
            errors.push(`${campaignBatch}: ${error.message}`);
        }
    }
    
    if (successCount > 0) {
        alert(`Successfully ${hardDelete ? 'permanently deleted' : 'soft deleted'} ${successCount} campaign(s).${errors.length > 0 ? ` Errors: ${errors.join('; ')}` : ''}`);
        loadCampaigns(); // Reload the list
    } else {
        alert(`Failed to delete campaigns. Errors: ${errors.join('; ')}`);
    }
}

async function deleteCampaign(campaignBatch, hardDelete) {
    const deleteType = hardDelete ? 'permanently delete' : 'soft delete';
    if (!confirm(`Are you sure you want to ${deleteType} campaign "${campaignBatch}"? This action ${hardDelete ? 'cannot be undone' : 'can be undone'}.`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/delete-campaign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                campaign_batch: campaignBatch, 
                hard_delete: hardDelete 
            })
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            alert(`Campaign ${hardDelete ? 'permanently deleted' : 'soft deleted'} successfully: ${result.message}`);
            loadCampaigns(); // Reload the list
        } else {
            alert(`Failed to delete campaign: ${result.message}`);
        }
    } catch (error) {
        alert(`Error deleting campaign: ${error.message}`);
    }
}

async function editCampaignName(campaignBatch, currentName) {
    const newName = prompt('Edit campaign name:', currentName);
    if (newName === null || newName === currentName) {
        return; // User cancelled or no change
    }
    
    try {
        // Note: We'll need to implement this API endpoint
        const response = await fetch('/api/update-campaign-name', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                campaign_batch: campaignBatch, 
                display_name: newName 
            })
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            loadCampaigns(); // Reload to show updated name
        } else {
            alert(`Failed to update campaign name: ${result.message}`);
        }
    } catch (error) {
        alert(`Error updating campaign name: ${error.message}`);
    }
}

// Load campaigns when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadCampaigns();
});
</script>
{% endblock %}