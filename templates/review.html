{% extends "base.html" %}

{% block title %}Review Tweets - CoopHive{% endblock %}

{% block extra_css %}
<style>
    .tweet-editor {
        margin-bottom: 30px;
    }

    .tweet-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .tweet-id {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .tweet-type {
        background: #e3f2fd;
        color: #1976d2;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .tweet-content-area {
        position: relative;
        margin-bottom: 20px;
    }

    .tweet-textarea {
        width: 100%;
        min-height: 120px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 15px;
        font-size: 1.1rem;
        line-height: 1.5;
        resize: vertical;
        transition: all 0.3s ease;
        background: #fafafa;
    }

    .tweet-textarea:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .char-counter {
        position: absolute;
        bottom: 10px;
        right: 15px;
        font-size: 0.9rem;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 10px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .char-counter.good { color: #28a745; }
    .char-counter.warning { color: #ffc107; }
    .char-counter.danger { color: #dc3545; }

    .tweet-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .meta-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
    }

    .meta-label {
        font-weight: 600;
        color: #667eea;
        font-size: 0.9rem;
        text-transform: uppercase;
        margin-bottom: 8px;
    }

    .meta-value {
        font-size: 0.95rem;
        color: #555;
    }

    .elements-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .element-tag {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .tweet-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .strategy-summary {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border: 1px solid #ffeaa7;
        margin-bottom: 30px;
    }

    .strategy-summary h3 {
        color: #856404;
        margin-bottom: 15px;
    }

    .preview-mode {
        background: #f8f9fa;
        border: 2px dashed #667eea;
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 1.1rem;
        line-height: 1.4;
    }

    .tweet-preview {
        background: white;
        border: 1px solid #e1e8ed;
        border-radius: 16px;
        padding: 16px;
        margin: 10px 0;
        max-width: 500px;
    }

    .batch-actions {
        position: static;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        clear: both;
    }

    .batch-actions h3 {
        margin-bottom: 15px;
        color: #667eea;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-item {
        text-align: center;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 10px;
    }

    .stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #667eea;
        display: block;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
    }

            .action-indicators {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .action-indicator {
            font-size: 1.2rem;
            padding: 2px 4px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            cursor: help;
            transition: all 0.3s ease;
        }

        .action-indicator:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .saved-indicator {
            background: #d4edda;
            border-color: #c3e6cb;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        @media (max-width: 768px) {
            .tweet-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .tweet-actions {
                justify-content: center;
            }
            
            .batch-actions {
                position: static;
            }
        }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/campaigns" class="btn btn-secondary">‚Üê Back to Campaigns</a>
    <a href="/" class="btn btn-secondary" style="margin-left: 10px;">üè† Home</a>
</div>

<!-- Campaign Statistics -->
<div class="card batch-actions">
    <h3>üìä Campaign Overview</h3>
    <div class="stats-grid">
        <div class="stat-item">
            <span class="stat-number">{{ campaign.tweet_count }}</span>
            <span class="stat-label">Total Tweets</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="draft-count">{{ campaign.tweets | selectattr('status', 'equalto', 'Draft') | list | length }}</span>
            <span class="stat-label">üìù Draft</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="approved-count">{{ campaign.tweets | selectattr('status', 'equalto', 'Approved') | list | length }}</span>
            <span class="stat-label">‚úÖ Approved</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="posted-count">{{ campaign.tweets | selectattr('status', 'equalto', 'Posted') | list | length }}</span>
            <span class="stat-label">üöÄ Posted</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="rejected-count">{{ campaign.tweets | selectattr('status', 'equalto', 'Rejected') | list | length }}</span>
            <span class="stat-label">‚ùå Rejected</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="deleted-count">{{ campaign.tweets | selectattr('status', 'equalto', 'Deleted') | list | length }}</span>
            <span class="stat-label">üóëÔ∏è Deleted</span>
        </div>
    </div>
    
    <!-- Action Summary -->
    <div id="action-summary" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem; color: #666;">
        <strong>üéØ Action Tracking:</strong> Watch for action indicators (üíæ‚úÖüöÄ‚ùå) next to each tweet ID to see what's been done. The üíæ appears when you save changes and auto-hides after 8 seconds.
    </div>
    
    <div class="tweet-actions">
        <button class="btn btn-success" onclick="approveAll()">‚úÖ Approve All</button>
        <button class="btn btn-primary" onclick="saveAll()">üíæ Save All Changes</button>
        <button class="btn btn-secondary" onclick="togglePreview()">üëÅÔ∏è Preview Mode</button>
    </div>
</div>

<!-- Strategy Summary -->
{% if campaign.analysis_summary %}
<div class="card strategy-summary">
    <h3>üéØ Content Strategy</h3>
    {% if campaign.analysis_summary.dominant_themes %}
        <p><strong>Themes:</strong> {{ campaign.analysis_summary.dominant_themes | join(', ') if campaign.analysis_summary.dominant_themes is iterable and campaign.analysis_summary.dominant_themes is not string else campaign.analysis_summary.dominant_themes }}</p>
    {% endif %}
    {% if campaign.analysis_summary.content_strategy %}
        <p><strong>Strategy:</strong> {{ campaign.analysis_summary.content_strategy }}</p>
    {% endif %}
    {% if campaign.analysis_summary.input_batch_size %}
        <p><strong>Batch Size:</strong> {{ campaign.analysis_summary.input_batch_size }} tweets processed</p>
    {% endif %}
    {% if campaign.analysis_summary.top_engagement_score %}
        <p><strong>Top Score:</strong> {{ campaign.analysis_summary.top_engagement_score }}</p>
    {% endif %}
</div>
{% endif %}

<!-- Tweet Editors -->
{% for tweet in campaign.tweets %}
<div class="card tweet-editor" data-tweet-id="{{ tweet.id }}" 
     {% if tweet.status == 'Deleted' %}style="opacity: 0.6; border: 2px dashed #6c757d;"{% endif %}>
    <div class="tweet-header">
        <div>
            <span class="tweet-id">{{ tweet.id }}</span>
            <span class="tweet-type">{{ tweet.type.replace('_', ' ') if tweet.type else 'TWEET' }}</span>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <!-- Action History Indicators -->
            <div class="action-indicators" data-tweet-id="{{ tweet.id }}">
                <span class="action-indicator saved-indicator" title="Changes Saved - Click to hide" style="display: none;">üíæ</span>
                <span class="action-indicator approved-indicator" title="Approved ‚úì" style="display: {{ 'inline-block' if tweet.status == 'Approved' else 'none' }};">‚úÖ</span>
                <span class="action-indicator posted-indicator" title="Posted to X ‚úì" style="display: {{ 'inline-block' if tweet.status == 'Posted' else 'none' }};">üöÄ</span>
                <span class="action-indicator rejected-indicator" title="Rejected ‚úì" style="display: {{ 'inline-block' if tweet.status == 'Rejected' else 'none' }};">‚ùå</span>
                <span class="action-indicator deleted-indicator" title="Deleted ‚úì" style="display: {{ 'inline-block' if tweet.status == 'Deleted' else 'none' }};">üóëÔ∏è</span>
            </div>
            <span class="status-badge status-{{ tweet.status.lower() if tweet.status else 'draft' }}">
                {{ tweet.status or 'Draft' }}
            </span>
        </div>
    </div>
    
    <div class="tweet-content-area">
        <textarea 
            class="tweet-textarea" 
            data-tweet-id="{{ tweet.id }}"
            placeholder="Edit your tweet content..."
            maxlength="280"
            oninput="updateCharCount(this)"
            {% if tweet.status == 'Deleted' %}
            disabled 
            style="background-color: #f8f9fa; color: #6c757d; cursor: not-allowed;"
            {% endif %}
        >{{ tweet.content }}</textarea>
        <div class="char-counter" id="counter-{{ tweet.id }}">{{ tweet.character_count }}/280</div>
    </div>
    
    <div class="tweet-meta">
        <div class="meta-item">
            <div class="meta-label">Engagement Hook</div>
            <div class="meta-value">{{ tweet.engagement_hook }}</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">CoopHive Elements</div>
            <div class="meta-value">
                <div class="elements-list">
                    {% for element in tweet.coophive_elements %}
                    <span class="element-tag">{{ element }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Discord Voice Patterns</div>
            <div class="meta-value">{{ tweet.discord_voice_patterns | join(', ') }}</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Theme Connection</div>
            <div class="meta-value">{{ tweet.theme_connection }}</div>
        </div>
    </div>
    
    <div class="tweet-actions">
        <button class="btn btn-primary" onclick="saveTweet('{{ tweet.id }}')" 
                {% if tweet.status == 'Deleted' %}disabled style="opacity: 0.5; cursor: not-allowed;">üíæ Disabled{% else %}>üíæ Save Changes{% endif %}</button>
        <button class="btn btn-success" onclick="updateStatus('{{ tweet.id }}', 'Approved')" 
                {% if tweet.status == 'Deleted' %}disabled style="opacity: 0.5; cursor: not-allowed;">‚úÖ Disabled{% else %}>‚úÖ Approve{% endif %}</button>
        <button class="btn btn-secondary" onclick="postToX('{{ tweet.id }}')" 
                {% if tweet.status == 'Deleted' %}disabled style="opacity: 0.5; cursor: not-allowed;">üöÄ Disabled{% else %}>üöÄ Post to X.com{% endif %}</button>
        <button class="btn btn-danger" onclick="updateStatus('{{ tweet.id }}', 'Rejected')" 
                {% if tweet.status == 'Deleted' %}disabled style="opacity: 0.5; cursor: not-allowed;">‚ùå Disabled{% else %}>‚ùå Reject{% endif %}</button>
        <button class="btn btn-danger" onclick="deleteTweet('{{ tweet.id }}')" style="margin-left: 10px;" 
                {% if tweet.status == 'Deleted' %}disabled style="margin-left: 10px; opacity: 0.5; cursor: not-allowed;">üóëÔ∏è Deleted{% else %}>üóëÔ∏è Delete{% endif %}</button>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
    const campaignBatch = '{{ campaign_batch }}';
    const token = '{{ token }}';
    let previewMode = false;

    // Update character count in real-time
    function updateCharCount(textarea) {
        const tweetId = textarea.dataset.tweetId;
        const counter = document.getElementById(`counter-${tweetId}`);
        const count = textarea.value.length;
        
        counter.textContent = `${count}/280`;
        
        // Update counter color
        counter.className = 'char-counter';
        if (count <= 240) {
            counter.classList.add('good');
        } else if (count <= 270) {
            counter.classList.add('warning');
        } else {
            counter.classList.add('danger');
        }
    }

    // Initialize character counters
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.tweet-textarea').forEach(textarea => {
            updateCharCount(textarea);
        });
    });

    // Save individual tweet
    async function saveTweet(tweetId) {
        // Check if tweet is deleted
        const tweetCard = document.querySelector(`[data-tweet-id="${tweetId}"]`);
        const statusBadge = tweetCard.querySelector('.status-badge');
        if (statusBadge.textContent.trim() === 'Deleted') {
            showNotification('Cannot save deleted tweet', 'error');
            return;
        }
        
        const textarea = document.querySelector(`textarea[data-tweet-id="${tweetId}"]`);
        const button = event.target;
        
        if (!textarea) {
            showNotification('Tweet editor not found', 'error');
            return;
        }
        
        button.dataset.originalText = button.innerHTML;
        setLoading(button, true);
        
        try {
            const result = await apiCall('/api/save-tweet', {
                campaign_batch: campaignBatch,
                tweet_id: tweetId,
                content: textarea.value
            }, 'POST');
            
            showNotification(result.message, 'success');
            
            // Update character counter
            updateCharCount(textarea);
            
            // Mark as edited
            const tweetCard = textarea.closest('.tweet-editor');
            if (tweetCard) {
                let editedBadge = tweetCard.querySelector('.edited-badge');
                if (!editedBadge) {
                    editedBadge = document.createElement('span');
                    editedBadge.className = 'edited-badge';
                    editedBadge.style.cssText = 'background: #ffc107; color: #856404; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 10px;';
                    editedBadge.textContent = 'EDITED';
                    tweetCard.querySelector('.tweet-header').appendChild(editedBadge);
                }
                
                // Show saved indicator
                const savedIndicator = tweetCard.querySelector('.saved-indicator');
                if (savedIndicator) {
                    savedIndicator.style.display = 'inline-block';
                    
                    // Add click to hide functionality
                    savedIndicator.onclick = function() {
                        this.style.display = 'none';
                    };
                    
                    // Auto-hide after 8 seconds
                    setTimeout(() => {
                        if (savedIndicator.style.display !== 'none') {
                            savedIndicator.style.display = 'none';
                        }
                    }, 8000);
                }
            }
            
        } catch (error) {
            showNotification(error.message, 'error');
        } finally {
            setLoading(button, false);
        }
    }

    // Update tweet status
    async function updateStatus(tweetId, status) {
        // Check if tweet is deleted
        const tweetCard = document.querySelector(`[data-tweet-id="${tweetId}"]`);
        const statusBadge = tweetCard.querySelector('.status-badge');
        if (statusBadge.textContent.trim() === 'Deleted') {
            showNotification('Cannot change status of deleted tweet', 'error');
            return;
        }
        
        const button = event.target;
        button.dataset.originalText = button.innerHTML;
        setLoading(button, true);
        
        try {
            const result = await apiCall('/api/update-status', {
                campaign_batch: campaignBatch,
                tweet_id: tweetId,
                status: status
            }, 'POST');
            
            showNotification(result.message, 'success');
            
            // Update status badge
            const statusBadge = document.querySelector(`[data-tweet-id="${tweetId}"] .status-badge`);
            statusBadge.textContent = status;
            statusBadge.className = `status-badge status-${status.toLowerCase()}`;
            
            // Show/hide appropriate action indicators
            const tweetCard = document.querySelector(`[data-tweet-id="${tweetId}"]`);
            const indicators = tweetCard.querySelector('.action-indicators');
            
            // Hide all status indicators first
            indicators.querySelector('.approved-indicator').style.display = 'none';
            indicators.querySelector('.posted-indicator').style.display = 'none';
            indicators.querySelector('.rejected-indicator').style.display = 'none';
            
            // Show the appropriate indicator
            if (status === 'Approved') {
                indicators.querySelector('.approved-indicator').style.display = 'inline-block';
            } else if (status === 'Posted') {
                indicators.querySelector('.posted-indicator').style.display = 'inline-block';
            } else if (status === 'Rejected') {
                indicators.querySelector('.rejected-indicator').style.display = 'inline-block';
            }
            
            // Update status counters
            updateStatusCounters();
            
            // Show option to go to status page
            setTimeout(() => {
                const statusUrl = `/${status.toLowerCase()}`;
                showNotification(`Tweet moved to ${status}! <a href="${statusUrl}" style="color: white; text-decoration: underline;">View ${status} tweets</a>`, 'success');
            }, 1000);
            
        } catch (error) {
            showNotification(error.message, 'error');
        } finally {
            setLoading(button, false);
        }
    }

    // Delete tweet function
    async function deleteTweet(tweetId) {
        // Check if tweet is already deleted
        const tweetCard = document.querySelector(`[data-tweet-id="${tweetId}"]`);
        const statusBadge = tweetCard.querySelector('.status-badge');
        
        if (statusBadge.textContent.trim() === 'Deleted') {
            showNotification('Tweet is already deleted', 'error');
            return;
        }
        
        if (!confirm('Are you sure you want to delete this tweet? This will mark it as deleted.')) {
            return;
        }
        
        const button = event.target;
        
        // Prevent multiple clicks
        if (button.disabled) {
            return;
        }
        
        button.dataset.originalText = button.innerHTML;
        button.innerHTML = '‚è≥ Deleting...';
        button.disabled = true;
        
        try {
            const response = await fetch('/api/delete-tweet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    campaign_batch: campaignBatch,
                    tweet_id: tweetId
                })
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Delete failed');
            }
            
            showNotification(result.message, 'success');
            
            console.log('Delete successful, updating UI for tweet:', tweetId);
            
            // Update the tweet status to Deleted instead of removing
            if (tweetCard) {
                // Update status badge
                const statusBadge = tweetCard.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.textContent = 'Deleted';
                    statusBadge.className = 'status-badge status-deleted';
                }
                
                // Show deleted indicator
                const indicators = tweetCard.querySelector('.action-indicators');
                if (indicators) {
                    // Hide other indicators
                    const approvedIndicator = indicators.querySelector('.approved-indicator');
                    const postedIndicator = indicators.querySelector('.posted-indicator');
                    const rejectedIndicator = indicators.querySelector('.rejected-indicator');
                    
                    if (approvedIndicator) approvedIndicator.style.display = 'none';
                    if (postedIndicator) postedIndicator.style.display = 'none';
                    if (rejectedIndicator) rejectedIndicator.style.display = 'none';
                    
                    // Add deleted indicator
                    let deletedIndicator = indicators.querySelector('.deleted-indicator');
                    if (!deletedIndicator) {
                        deletedIndicator = document.createElement('span');
                        deletedIndicator.className = 'action-indicator deleted-indicator';
                        deletedIndicator.title = 'Deleted ‚úì';
                        deletedIndicator.innerHTML = 'üóëÔ∏è';
                        indicators.appendChild(deletedIndicator);
                    }
                    deletedIndicator.style.display = 'inline-block';
                }
                
                // Add visual indication that tweet is deleted
                tweetCard.style.opacity = '0.6';
                tweetCard.style.border = '2px dashed #6c757d';
                
                // Disable ALL action buttons for deleted tweet
                const allButtons = tweetCard.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                });
                
                // Update button texts to show disabled state
                const saveBtn = tweetCard.querySelector('button[onclick*="saveTweet"]');
                const approveBtn = tweetCard.querySelector('button[onclick*="Approved"]');
                const postBtn = tweetCard.querySelector('button[onclick*="postToX"]');
                const rejectBtn = tweetCard.querySelector('button[onclick*="Rejected"]');
                const deleteBtn = tweetCard.querySelector('button[onclick*="deleteTweet"]');
                
                if (saveBtn) saveBtn.innerHTML = 'üíæ Disabled';
                if (approveBtn) approveBtn.innerHTML = '‚úÖ Disabled';
                if (postBtn) postBtn.innerHTML = 'üöÄ Disabled';
                if (rejectBtn) rejectBtn.innerHTML = '‚ùå Disabled';
                if (deleteBtn) deleteBtn.innerHTML = 'üóëÔ∏è Deleted';
                
                // Disable the textarea too
                const textarea = tweetCard.querySelector('textarea');
                if (textarea) {
                    textarea.disabled = true;
                    textarea.style.backgroundColor = '#f8f9fa';
                    textarea.style.color = '#6c757d';
                    textarea.style.cursor = 'not-allowed';
                }
                
                // Update counters
                updateStatusCounters();
                
                // Show success message with link to deleted tweets
                setTimeout(() => {
                    showNotification(`Tweet deleted! <a href="/deleted" style="color: white; text-decoration: underline;">View deleted tweets</a>`, 'success');
                }, 1000);
            }
            
        } catch (error) {
            console.error('Delete error:', error);
            showNotification(error.message || 'Delete failed', 'error');
            // Re-enable button on error
            button.innerHTML = button.dataset.originalText || 'üóëÔ∏è Delete';
            button.disabled = false;
        } finally {
            // Don't re-enable if successfully deleted (button is already disabled above)
            // The finally block should not interfere with successful deletion
        }
    }

    // Post to X.com
    async function postToX(tweetId) {
        // Check if tweet is deleted
        const tweetCard = document.querySelector(`[data-tweet-id="${tweetId}"]`);
        const statusBadge = tweetCard.querySelector('.status-badge');
        if (statusBadge.textContent.trim() === 'Deleted') {
            showNotification('Cannot post deleted tweet', 'error');
            return;
        }
        
        if (!confirm('Are you sure you want to post this tweet to X.com? This action cannot be undone.')) {
            return;
        }
        
        const button = event.target;
        button.dataset.originalText = button.innerHTML;
        setLoading(button, true);
        
        try {
            const result = await apiCall('/api/post-to-x', {
                campaign_batch: campaignBatch,
                tweet_id: tweetId
            }, 'POST');
            
            showNotification(result.message, 'success');
            
            // Update status to Posted
            updateStatus(tweetId, 'Posted');
            
        } catch (error) {
            showNotification(error.message, 'error');
        } finally {
            setLoading(button, false);
        }
    }

    // Batch operations
    async function approveAll() {
        const tweetIds = Array.from(document.querySelectorAll('[data-tweet-id]')).map(el => el.dataset.tweetId);
        
        for (const tweetId of tweetIds) {
            await updateStatus(tweetId, 'Approved');
        }
        
        showNotification(`Approved ${tweetIds.length} tweets`, 'success');
    }

    async function saveAll() {
        const textareas = document.querySelectorAll('.tweet-textarea');
        let savedCount = 0;
        
        for (const textarea of textareas) {
            try {
                const response = await apiCall('/api/save-tweet', {
                    campaign_batch: campaignBatch,
                    tweet_id: textarea.dataset.tweetId,
                    content: textarea.value
                }, 'POST');
                
                savedCount++;
                updateCharCount(textarea);
                
            } catch (error) {
                console.error('Failed to save tweet:', error);
            }
        }
        
        showNotification(`Saved ${savedCount} of ${textareas.length} tweets`, 'success');
    }

    function togglePreview() {
        previewMode = !previewMode;
        const textareas = document.querySelectorAll('.tweet-textarea');
        
        textareas.forEach(textarea => {
            if (previewMode) {
                // Create preview div
                const preview = document.createElement('div');
                preview.className = 'tweet-preview';
                preview.innerHTML = textarea.value;
                textarea.style.display = 'none';
                textarea.parentNode.insertBefore(preview, textarea);
            } else {
                // Remove preview and show textarea
                const preview = textarea.parentNode.querySelector('.tweet-preview');
                if (preview) {
                    preview.remove();
                }
                textarea.style.display = 'block';
            }
        });
        
        const button = document.querySelector('button[onclick="togglePreview()"]');
        button.innerHTML = previewMode ? '‚úèÔ∏è Edit Mode' : 'üëÅÔ∏è Preview Mode';
    }
    
    // Update status counters
    function updateStatusCounters() {
        const allTweets = document.querySelectorAll('.tweet-editor');
        let draftCount = 0, approvedCount = 0, postedCount = 0, rejectedCount = 0, deletedCount = 0;
        
        allTweets.forEach(tweet => {
            const statusBadge = tweet.querySelector('.status-badge');
            const status = statusBadge.textContent.trim();
            
            switch(status) {
                case 'Draft': draftCount++; break;
                case 'Approved': approvedCount++; break;
                case 'Posted': postedCount++; break;
                case 'Rejected': rejectedCount++; break;
                case 'Deleted': deletedCount++; break;
            }
        });
        
        // Update counters
        document.getElementById('draft-count').textContent = draftCount;
        document.getElementById('approved-count').textContent = approvedCount;
        document.getElementById('posted-count').textContent = postedCount;
        document.getElementById('rejected-count').textContent = rejectedCount;
        
        // Update deleted count if element exists
        const deletedCountElement = document.getElementById('deleted-count');
        if (deletedCountElement) {
            deletedCountElement.textContent = deletedCount;
        }
    }
</script>
{% endblock %}